---
title: "California Wildfire Report `r format(Sys.time(), '%b %d, %Y')`"
author: '[Matthew Coleman](https://matthewbcoleman.github.io/)'
subtitle: 'Daily Report of California Wildfires (I am Interactive!)'
output: 
  html_document:
    theme: journal
      #after_body: footer.html
---

```{r, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message=FALSE)
```


```{r}
library(sf)
library(tidyverse)
library(USAboundaries)
library(ggthemes)
library(units)
library(plotly)
library(plotly)
```




```{r}
#Download file, unzip, and read in fire data
temp <- tempfile()
url <- 'https://firms.modaps.eosdis.nasa.gov/data/active_fire/suomi-npp-viirs-c2/shapes/zips/SUOMI_VIIRS_C2_Global_24h.zip'
download.file(url,temp)
unzip(temp, exdir = 'data')
data <- read_sf('data/SUOMI_VIIRS_C2_Global_24h.shp', crs = 4326) %>% st_transform(5070)
unlink(temp)

```


```{r}
#get the county data, filter to CA and add area column for point area.

counties_raw <- USAboundaries::us_counties(resolution = 'low') %>%  
  st_transform(crs = 4326) %>% st_transform(5070)

counties_ca <- counties_raw %>% filter(state_name == 'California')

california <- counties_ca %>% st_combine() 

ca_fires <- st_filter(data, california, .predicate = st_within) %>% 
  st_as_sf() %>% 
  mutate(area_km = (375^2)/1000000)

county_indices <- st_within(ca_fires, counties_ca)

ca_fires <- ca_fires %>% mutate(county = counties_ca$name[unlist(county_indices)]) %>% 
  st_buffer(375)

```

```{r}
point_in_polygon = function(points, polygon, id){
  st_join(points, polygon) %>%
    st_drop_geometry() %>%
    count(.data[[id]]) %>%
    setNames(c(id, "n")) %>%
    left_join(polygon, by = id) %>%
    st_as_sf()
}

fire_counts <- point_in_polygon(ca_fires, counties_ca, 'countyfp')
```


```{r, out.width="1000px", out.height="1000px"}

#Plot Map

g <- ggplot() +
  geom_sf(data = california) +
  geom_sf(data = ca_fires, col = 'red4', alpha = .5, size = .5) +
  geom_sf(data = fire_counts, aes(fill = log(n)), alpha = .9, size = .2) +
  scale_fill_gradient(low = "white", high = "brown") +
  theme(legend.position = 'none') +
  theme_linedraw() +
  labs(x = 'Longitude',
       y = 'Latitude', 
       title = paste0('Location of Fires in California on ', format(Sys.Date(), format = '%b %d, %Y') ) ) 
#g

#ifelse({st_distance(ca_fires$geometry,ca_fires$geometry)%>% drop_units() %>% .[1]}  <= 800, st_join(ca_fires$geometry,ca_fires$geometry),ca_fires$geometry)  
#st_distance(ca_fires$geometry[4],ca_fires$geometry[5]) %>% drop_units() %>% .[1] <593

ggplotly(g, tooltip = 'text')
```


```{r}
fire_counts <- ca_fires %>% 
  group_by(county) %>% 
  summarise(fire_count = n()) %>% #, fire_area = sum(area_km)) %>% 
  ungroup() %>% 
  st_set_geometry(NULL)

```




```{bash message=FALSE, include=FALSE}
git pull
git add .
git commit -m 'daily updates'
git push
```

*************************


<center>

[Code](https://github.com/matthewbcoleman/wildfiremap)
[GitHub](https://github.com/matthewbcoleman)
[Data](https://firms.modaps.eosdis.nasa.gov/active_fire/#firms-shapefile)

</center>

